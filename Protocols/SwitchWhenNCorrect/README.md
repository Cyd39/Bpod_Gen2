# SwitchWhenNCorrect Protocol (TrialManager Version)

## Protocol Description
The SwitchWhenNCorrect protocol automatically switches stimulus sides (high frequency/low frequency) after the animal has made N consecutive correct responses. This protocol implements an adaptive side-switching mechanism for psychophysics experiments. This version uses BpodTrialManager to manage trial execution, providing better performance and shorter inter-trial intervals.

## Main Features
1. **Continuous Stimulus Presentation**: Continuously presents stimuli on one side (high frequency or low frequency)
2. **LeftRight Table Reading**: Reads the next stimulus from the sequence table generated by GenLeftRightSeq
3. **N-Correct Switching**: Automatically switches to the other side after accumulating N correct trials
4. **Parameter GUI Control**: Set N value and other parameters through Bpod protocol GUI
5. **TrialManager Optimization**: Uses BpodTrialManager for parallel processing, reducing inter-trial intervals

## Parameter Settings
- `NCorrectToSwitch`: Number of correct trials required to switch sides (default: 5)
- `MinITI`/`MaxITI`: Inter-trial interval time range
- `MinQuietTime`/`MaxQuietTime`: Quiet time range
- `RewardAmount`: Reward amount (µL)
- `ResWin`: Response window time

## Workflow
1. Start from low frequency side (currentSide = 1)
2. Read stimulus parameters from LeftRightSeq.LowFreqTable (starting from index 1)
3. Use PrepareStateMachine function to prepare state machine
4. Start trial through TrialManager, parallel processing of next trial preparation
5. Present stimulus, detect animal response
6. Increment correctCount counter on correct response
7. Switch to high frequency side when correctCount reaches NCorrectToSwitch
8. Read stimulus parameters from LeftRightSeq.HighFreqTable (continue from current index)
9. Repeat the above process, switching between sides

## Indexing Logic
- **Independent Indices**: High frequency and low frequency tables maintain independent index counters
- **Continuous Increment**: Each table's index starts from 1, continuously increments, does not reset when switching sides
- **Direct Reading**: Table length matches trial count, index directly corresponds to table position
- **Table Length Requirement**: LeftRightSeq tables should contain sufficient stimuli to support the entire experiment's trial count
- **Example**: High freq 1-5 → switch → Low freq 1-5 → switch → High freq 6-10 → switch → Low freq 6-10

### Detailed Example (assuming sufficient stimuli on each side):
1. **Trials 1-5**: Low frequency side, low frequency index 1-5
2. **Side Switch**: Switch to high frequency side after reaching N correct responses
3. **Trials 6-10**: High frequency side, high frequency index 1-5
4. **Side Switch**: Switch to low frequency side after reaching N correct responses
5. **Trials 11-15**: Low frequency side, low frequency index 6-10
6. **Side Switch**: Switch to high frequency side after reaching N correct responses
7. **Trials 16-20**: High frequency side, high frequency index 6-10

### Index State Example:
- **Low Frequency Index**: 1→2→3→4→5→6→7→8→9→10→11...
- **High Frequency Index**: 1→2→3→4→5→6→7→8→9→10→11...
- Two indices are completely independent, continuously incrementing
- Directly read stimuli from corresponding table positions

### Actual Trial Sequence Example:
Assuming sufficient stimuli on each side, N=3 correct responses to switch:

| Trial | Current Side | Index | Stimulus Source | Description |
|-------|--------------|-------|-----------------|-------------|
| 1     | Low Freq     | 1     | LowFreqTable[1] | Low freq index=1 |
| 2     | Low Freq     | 2     | LowFreqTable[2] | Low freq index=2 |
| 3     | Low Freq     | 3     | LowFreqTable[3] | Low freq index=3, reach N=3, switch |
| 4     | High Freq    | 1     | HighFreqTable[1]| High freq index=1 |
| 5     | High Freq    | 2     | HighFreqTable[2]| High freq index=2 |
| 6     | High Freq    | 3     | HighFreqTable[3]| High freq index=3, reach N=3, switch |
| 7     | Low Freq     | 4     | LowFreqTable[4] | Low freq index=4 (continue) |
| 8     | Low Freq     | 5     | LowFreqTable[5] | Low freq index=5 |
| 9     | Low Freq     | 6     | LowFreqTable[6] | Low freq index=6 (continue) |
| 10    | Low Freq     | 7     | LowFreqTable[7] | Low freq index=7 (continue) |
| 11    | Low Freq     | 8     | LowFreqTable[8] | Low freq index=8 (continue), reach N=3, switch |
| 12    | High Freq    | 4     | HighFreqTable[4]| High freq index=4 (continue) |

## TrialManager Advantages
- **Parallel Processing**: Prepare next trial's state machine while current trial is running
- **Shorter Intervals**: Reduce dead time between trials
- **Better Performance**: Allow MATLAB to execute other tasks during trials
- **Real-time Updates**: Support parameter adjustment and data analysis during trials

## Data Recording
The protocol records the following data:
- Current side (CurrentSide)
- Correct side (CorrectSide)
- Stimulus parameters (CurrentStimRow)
- Response correctness (IsCorrect)
- Correct count (CorrectCount)
- Whether it's a catch trial (IsCatchTrial)

## Usage Instructions
1. Start protocol through Controller.m
2. Set stimulus parameters in StimParamGui
3. Set behavior parameters like NCorrectToSwitch in BpodParameterGUI
4. Click "Update Parameters" button to update parameters
5. Start experiment

## Notes
- The protocol automatically handles stimulus sequence table cycling (resets index when reaching end)
- Catch trials are not counted in correct response count
- Incorrect responses reset correct count to 0
- Supports pause and stop functionality