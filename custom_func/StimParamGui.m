function StimParams = StimParamGui()
    % Create handle structure
    h = struct();
    
    h_gui = figure('Name', 'Stimulus Parameter Setting', ...
        'NumberTitle', 'off', ...
        'Position', [500 100 1000 800], ...
        'MenuBar', 'none');

    % Session type selection (normalized)
    uicontrol('Style', 'text', ...
        'String', 'Session Type:', ...
        'Units', 'normalized', ...
        'Position', [0.06 0.93 0.18 0.03], ...
        'FontSize', 14);
    h.SessionType = uicontrol('Style', 'popup', ...
        'String', {'Multimodal', 'SoundOnly', 'VibrationOnly'}, ...
        'Units', 'normalized', ...
        'Position', [0.25 0.93 0.15 0.03], ...
        'FontSize', 14, ...
        'Callback', @sessionTypeChanged);

    % Stimulus Duration
    uicontrol('Style', 'text', ...
        'String', 'Stimulus Duration(ms):', ...
        'Units', 'normalized', ...
        'Position', [0.02 0.87 0.2 0.03],...
        'FontSize', 14);
    h.Duration = uicontrol('Style', 'edit', ...
        'String', '500', ...
        'Units', 'normalized', ...
        'Position', [0.25 0.87 0.18 0.03],...
        'FontSize', 14);
    

    % Ramp Time
    uicontrol('Style', 'text', ...
        'String', 'Ramp Time(ms):', ...
        'Units', 'normalized', ...
        'Position', [0.05 0.83 0.18 0.03],...
        'FontSize', 14);
    h.Ramp = uicontrol('Style', 'edit', ...
        'String', '5', ...
        'Units', 'normalized', ...
        'Position', [0.25 0.83 0.18 0.03],...
        'FontSize', 14);

    % Sound stimulus parameters panel (normalized)
    soundPanel = uipanel('Title', 'Sound Stimulus Parameters', ...
        'Units', 'normalized', ...
        'Position', [.05 .37 .45 .45],...
        'FontSize', 16);

    % Sound type selection with callback (normalized)
    uicontrol('Parent', soundPanel, ...
        'Style', 'text', ...
        'String', 'Sound Type:', ...
        'Units', 'normalized', ...
        'Position', [0.05 0.85 0.35 0.1],...
        'FontSize', 14);
    h.SoundType = uicontrol('Parent', soundPanel, ...
        'Style', 'popup', ...
        'String', {'AM Noise', 'Click Train', 'White Noise', 'Bandpass Noise'}, ...
        'Units', 'normalized', ...
        'Position', [0.45 0.85 0.45 0.1],...
        'FontSize', 14,...
        'Callback', @soundTypeChanged);

    % Create parameter panels for each type (normalized)
    amPanel = uipanel('Parent', soundPanel,...
        'Title', 'AM Noise Parameters',...
        'Units', 'normalized', ...
        'Position', [0.05 0.05 0.9 0.8],...
        'Visible', 'on',...
        'FontSize', 12);

    clickPanel = uipanel('Parent', soundPanel,...
        'Title', 'Click Train Parameters',...
        'Units', 'normalized', ...
        'Position', [0.05 0.05 0.9 0.8],...
        'Visible', 'off',...
        'FontSize', 12);

    noisePanel = uipanel('Parent', soundPanel,...
        'Title', 'Noise Parameters',...
        'Units', 'normalized', ...
        'Position', [0.05 0.05 0.9 0.8],...
        'Visible', 'off',...
        'FontSize', 12);

    % Create controls for each panel
    createAMControls(amPanel);
    createClickControls(clickPanel);
    createNoiseControls(noisePanel);

    % Vibration panel (normalized)
    vibPanel = uipanel('Title', 'Vibration Stimulus Parameters', ...
        'Units', 'normalized', ...
        'Position', [.05 .1 .45 .25],...
        'FontSize', 16);
    createVibrationControls(vibPanel);

    % Behavior parameters panel (normalized)
    behavePanel = uipanel('Title', 'Behavior Parameters', ...
        'Units', 'normalized', ...
        'Position', [.52 .1 .43 .85],...
        'FontSize', 16);
    createBehaviorControls(behavePanel);

    % Set button (normalized)
    uicontrol('Style', 'pushbutton', ...
        'String', 'Set Parameters', ...
        'Units', 'normalized', ...
        'Position', [0.4 0.02 0.2 0.05], ...
        'FontSize', 14, ...
        'Callback', @setStimParams);

    function sessionTypeChanged(~, ~)
        sessionType = get(h.SessionType, 'Value');
        
        % Get all controls in sound panel
        soundControls = findall(soundPanel, 'Type', 'uicontrol');
        % Get all controls in vibration panel
        vibControls = findall(vibPanel, 'Type', 'uicontrol');
        
        switch sessionType
            case 1 % Multimodal
                % Enable all controls
                set(soundControls, 'Enable', 'on');
                set(vibControls, 'Enable', 'on');
                set(soundPanel, 'Title', 'Sound Stimulus Parameters');
                set(vibPanel, 'Title', 'Vibration Stimulus Parameters');
                
            case 2 % SoundOnly
                % Enable sound controls, disable vibration controls
                set(soundControls, 'Enable', 'on');
                set(vibControls, 'Enable', 'off');
                set(soundPanel, 'Title', 'Sound Stimulus Parameters');
                set(vibPanel, 'Title', 'Vibration Stimulus Parameters (Disabled)');
                
            case 3 % VibrationOnly
                % Disable sound controls, enable vibration controls
                set(soundControls, 'Enable', 'off');
                set(vibControls, 'Enable', 'on');
                set(soundPanel, 'Title', 'Sound Stimulus Parameters (Disabled)');
                set(vibPanel, 'Title', 'Vibration Stimulus Parameters');
        end
    end

    function soundTypeChanged(~, ~)
        type = get(h.SoundType, 'Value');
        set(amPanel, 'Visible', 'off');
        set(clickPanel, 'Visible', 'off');
        set(noisePanel, 'Visible', 'off');
        
        switch type
            case 1
                set(amPanel, 'Visible', 'on');
            case 2
                set(clickPanel, 'Visible', 'on');
            case {3, 4}
                set(noisePanel, 'Visible', 'on');
        end
    end

    function createAMControls(parent)
        % AM transition time
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'TransTime (ms):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.49 0.4 0.1],...
            'FontSize', 14);
        h.AM.TransitionTime = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '0', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.49 0.4 0.1],...
            'FontSize', 14);

        % AM transition duration
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'TransDur (ms):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.37 0.4 0.1],...
            'FontSize', 14);    
        h.AM.TransitionDuration = uicontrol('Parent', parent, ...   
            'Style', 'edit', ...
            'String', '-1', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.37 0.4 0.1],...
            'FontSize', 14);

        % Duration
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Duration (ms):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.25 0.4 0.1],...
            'FontSize', 14);
        h.AM.Duration = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '500', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.25 0.4 0.1],...
            'FontSize', 14,...
            'Enable', 'off');

        % Volume
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Volume (0-1):', ...
            'Units', 'normalized', ...
            'Position', [0.1 0.13 0.4 0.1],...
            'FontSize', 14);
        h.AM.Volume = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '0.3', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.13 0.4 0.1],...
            'FontSize', 14);

        % AM Frequency
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'AM Frequency (Hz):', ...
            'Units', 'normalized', ...
            'Position', [0.01 0.01 0.5 0.1],...
            'FontSize', 14);
        h.AM.Frequency = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '20', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.01 0.4 0.1],...
            'FontSize', 14);

        % Other AM controls...
        createRemainingAMControls(parent);
    end

    function createRemainingAMControls(parent)
        % AM Depth
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'AM Depth (0-1):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.85 0.4 0.1],...
            'FontSize', 14);
        h.AM.Depth = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '0.8', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.85 0.4 0.1],...
            'FontSize', 14);

        % Carrier Frequency
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Carrier Freq (Hz):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.73 0.4 0.1],...
            'FontSize', 14);
        h.AM.CarrierFreq = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '1000', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.73 0.4 0.1],...
            'FontSize', 14);

        % Bandwidth
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Bandwidth (Hz):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.61 0.4 0.12],...
            'FontSize', 14);
        h.AM.BandWidth = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '200', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.61 0.4 0.12],...
            'FontSize', 14);
    end

    function createClickControls(parent)
        % Click controls structure
        h.Click = struct();
        
        % Duration
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Duration (ms):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.85 0.4 0.1],...
            'FontSize', 14);
        h.Click.Duration = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '500', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.85 0.4 0.1],...
            'FontSize', 14,...
            'Enable', 'off');

        % Other click parameters...
        createRemainingClickControls(parent);
    end

    function createRemainingClickControls(parent)
        % Click Balance
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Click Balance:', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.72 0.4 0.1],...
            'FontSize', 14);
        h.Click.Balance = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '0', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.72 0.4 0.1],...
            'FontSize', 14);

        % Click Rate
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Click Rate (Hz):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.6 0.4 0.1],...
            'FontSize', 14);
        h.Click.Rate = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '10', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.6 0.4 0.1],...
            'FontSize', 14);

        % Click Amplitude
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Click Amplitude (0-1):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.48 0.4 0.1],...
            'FontSize', 14);
        h.Click.Amplitude = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '0.5', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.48 0.4 0.1],...
            'FontSize', 14);

        % Mask Intensity
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Mask Intensity (0-1):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.36 0.4 0.1],...
            'FontSize', 14);
        h.Click.MaskIntensity = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '0.1', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.36 0.4 0.1],...
            'FontSize', 14);
    end

    function createNoiseControls(parent)
        % Noise controls structure
        h.Noise = struct();
        
        % Duration
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Duration (ms):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.85 0.4 0.1],...
            'FontSize', 14);
        h.Noise.Duration = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '500', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.85 0.4 0.1],...
            'FontSize', 14,...
            'Enable', 'off');

        % Other noise parameters...
        createRemainingNoiseControls(parent);
    end

    function createRemainingNoiseControls(parent)
        % Intensity
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Level (dB):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.72 0.4 0.1],...
            'FontSize', 14);
        h.Noise.Level = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '0', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.72 0.4 0.1],...
            'FontSize', 14);

        % Low Frequency
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Low Freq (Hz):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.6 0.4 0.1],...
            'FontSize', 14);
        h.Noise.LowFreq = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '1000', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.6 0.4 0.1],...
            'FontSize', 14);

        % High Frequency
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'High Freq (Hz):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.48 0.4 0.1],...
            'FontSize', 14);
        h.Noise.HighFreq = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '20000', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.48 0.4 0.1],...
            'FontSize', 14);
    end

    function createVibrationControls(parent)
        % Vibration controls structure
        h.Vib = struct();
        
        % Waveform Type
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Waveform Type:', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.8 0.4 0.15],...
            'FontSize', 14);
        h.Vib.Type = uicontrol('Parent', parent, ...
            'Style', 'popup', ...
            'String', {'Square', 'UniSine', 'BiSine'}, ...
            'Units', 'normalized', ...
            'Position', [0.5 0.8 0.4 0.15],...
            'FontSize', 14);

        % Other vibration parameters...
        createRemainingVibrationControls(parent);
    end

    function createRemainingVibrationControls(parent)
        % Duration
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Duration (ms):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.5 0.4 0.15],...
            'FontSize', 14);
        h.Vib.Duration = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '500', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.5 0.4 0.15],...
            'FontSize', 14,...
            'Enable', 'off');

        % Amplitude
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Amplitude (V):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.3 0.4 0.15],...
            'FontSize', 14);
        h.Vib.Amplitude = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '0.5', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.3 0.4 0.15],...
            'FontSize', 14);

        % Frequency
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Frequency (Hz):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.1 0.4 0.15],...
            'FontSize', 14);
        h.Vib.Frequency = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '100', ...
            'Units', 'normalized', ...
            'Position', [0.5 0.1 0.4 0.15],...
            'FontSize', 14);

    end

    function createBehaviorControls(parent)
        % ITI parameters
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Inter-Trial Interval (ITI):', ...
            'Units', 'normalized', ...
            'Position', [0.01 0.9 0.55 0.04],...
            'FontSize', 14,...
            'FontWeight', 'bold');

        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Minimum ITI (s):', ...
            'Units', 'normalized', ...
            'Position', [0.2 0.85 0.3 0.04],...
            'FontSize', 12);
        h.Behave.MinITI = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '2', ...
            'Units', 'normalized', ...
            'Position', [0.6 0.85 0.3 0.04],...
            'FontSize', 12);

        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Maximum ITI (s):', ...
            'Units', 'normalized', ...
            'Position', [0.2 0.8 0.3 0.04],...
            'FontSize', 12);
        h.Behave.MaxITI = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '3', ...
            'Units', 'normalized', ...
            'Position', [0.6 0.8 0.3 0.04],...
            'FontSize', 12);

        % Quiet time parameters
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Quiet(No-lick) Time:', ...
            'Units', 'normalized', ...
            'Position', [0.01 0.75 0.5 0.04],...
            'FontSize', 14,...
            'FontWeight', 'bold');

        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Minimum Quiet Time (s):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.7 0.5 0.04],...
            'FontSize', 12);
        h.Behave.MinQuietTime = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '1', ...
            'Units', 'normalized', ...
            'Position', [0.6 0.7 0.3 0.04],...
            'FontSize', 12);

        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Maximum Quiet Time (s):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.65 0.5 0.04],...
            'FontSize', 12);
        h.Behave.MaxQuietTime = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '2', ...
            'Units', 'normalized', ...
            'Position', [0.6 0.65 0.3 0.04],...
            'FontSize', 12);

        % Response window parameters
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Response Window:', ...
            'Units', 'normalized', ...
            'Position', [0.01 0.6 0.5 0.04],...
            'FontSize', 14,...
            'FontWeight', 'bold');

        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Response Window Duration (s):', ...
            'Units', 'normalized', ...
            'Position', [0.01 0.55 0.6 0.04],...
            'FontSize', 12);
        h.Behave.ResWin = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '5', ...
            'Units', 'normalized', ...
            'Position', [0.6 0.55 0.3 0.04],...
            'FontSize', 12);

        % Reward parameters
        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Reward Settings:', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.5 0.4 0.04],...
            'FontSize', 14,...
            'FontWeight', 'bold');

        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Valve Open Time (s):', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.45 0.5 0.04],...
            'FontSize', 12);
        h.Behave.ValveTime = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '0.5', ...
            'Units', 'normalized', ...
            'Position', [0.6 0.45 0.3 0.04],...
            'FontSize', 12);
        
        % Number of Trials
        uicontrol('Parent',parent,...
            'Style', 'text', ...
            'String', 'Number of Trials:', ...
            'Units', 'normalized', ...
            'Position', [0.05 0.4 0.4 0.04],...
            'FontSize', 14,...
            'FontWeight', 'bold');

        uicontrol('Parent', parent, ...
            'Style', 'text', ...
            'String', 'Number of Trials:', ...
            'Units', 'normalized', ...
            'Position', [0.2 0.35 0.3 0.04],...
            'FontSize', 12);
        h.Behave.NumTrials = uicontrol('Parent', parent, ...
            'Style', 'edit', ...
            'String', '160', ...
            'Units', 'normalized', ...
            'Position', [0.6 0.35 0.3 0.04],...
            'FontSize', 12);
    end

    function setStimParams(~, ~)
        % Get session type
        sessionType = get(h.SessionType, 'Value');
        sessionTypeStr = get(h.SessionType, 'String');
        StimParams.Session.Type = sessionType;
        StimParams.Session.TypeName = sessionTypeStr{sessionType};
        
        % get sound type
        soundType = get(h.SoundType, 'Value');
        soundTypeStr = get(h.SoundType, 'String');
        StimParams.Sound.Type = soundType;
        StimParams.Sound.TypeName = soundTypeStr{soundType};
        StimParams.Duration = str2double(get(h.Duration, 'String')); % ms
        StimParams.Ramp = str2double(get(h.Ramp, 'String')); % ms
        
        % Only get sound parameters if not VibrationOnly
        if sessionType ~= 3
            switch soundType
                case 1 % AM Noise
                    % StimParams.Sound.Duration = str2double(get(h.AM.Duration, 'String'));
                    StimParams.Sound.Volume = str2double(get(h.AM.Volume, 'String'));
                    StimParams.Sound.AM.Frequency = str2double(get(h.AM.Frequency, 'String'));
                    StimParams.Sound.AM.Depth = str2double(get(h.AM.Depth, 'String'));
                    StimParams.Sound.AM.CarrierFreq = str2double(get(h.AM.CarrierFreq, 'String'));
                    StimParams.Sound.AM.BandWidth = str2double(get(h.AM.BandWidth, 'String'));
                    StimParams.Sound.AM.TransTime = str2double(get(h.AM.TransitionTime, 'String'))/1000;
                    StimParams.Sound.AM.TransDur = str2double(get(h.AM.TransitionDuration, 'String'))/1000;                   

                case 2 % Click Train
                    % StimParams.Sound.Duration = str2double(get(h.Click.Duration, 'String'));
                    StimParams.Sound.Click.Balance = str2double(get(h.Click.Balance, 'String'));
                    StimParams.Sound.Click.Rate = str2double(get(h.Click.Rate, 'String'));
                    StimParams.Sound.Click.Amplitude = str2double(get(h.Click.Amplitude, 'String'));
                    StimParams.Sound.Click.MaskIntensity = str2double(get(h.Click.MaskIntensity, 'String'));
                    
                case {3, 4} % Noise
                    % StimParams.Sound.Duration = str2double(get(h.Noise.Duration, 'String'));
                    StimParams.Sound.Noise.LowFreq = str2double(get(h.Noise.LowFreq, 'String'));
                    StimParams.Sound.Noise.HighFreq = str2double(get(h.Noise.HighFreq, 'String'));
                    % Handle Noise Level input
                    levelStr = get(h.Noise.Level, 'String');
                    try
                        % First try to handle comma-separated numbers
                        if contains(levelStr, ',')
                            % Split by comma and convert to numbers
                            parts = strsplit(levelStr, ',');
                            parts = cellfun(@str2double, parts, 'UniformOutput', false);
                            if all(~cellfun(@isnan, parts))
                                StimParams.Sound.Noise.Level = cell2mat(parts)';
                            else
                                error('Invalid number format in comma-separated list');
                            end
                        else
                            % Try to evaluate the string as a MATLAB expression
                            levelValue = eval(levelStr);
                            % Convert to column vector if it's a row vector
                            if size(levelValue, 1) == 1
                                levelValue = levelValue';
                            end
                            StimParams.Sound.Noise.Level = levelValue;
                        end
                    catch
                        % If evaluation fails, try to parse as a range
                        try
                            % Split the string by ':'
                            parts = strsplit(levelStr, ':');
                            % Convert all parts to numbers
                            parts = cellfun(@str2double, parts, 'UniformOutput', false);
                            % Check if all parts are valid numbers
                            if all(~cellfun(@isnan, parts))
                                switch length(parts)
                                    case 1
                                        % Single value
                                        StimParams.Sound.Noise.Level = parts{1};
                                    case 2
                                        % Start:End (default step = 1)
                                        StimParams.Sound.Noise.Level = (parts{1}:parts{2})';
                                    case 3
                                        % Start:Step:End
                                        StimParams.Sound.Noise.Level = (parts{1}:parts{2}:parts{3})';
                                    otherwise
                                        % Multiple values separated by colons
                                        StimParams.Sound.Noise.Level = cell2mat(parts)';
                                end
                            else
                                error('Invalid number format in range');
                            end
                        catch
                            error('Invalid Noise Level format. Please use one of these formats:\n- Comma separated: "4,5,10"\n- Space separated: "[4 5 10]"\n- Colon separated: "4:5:10"\n- Range with step: "0:5:60"');
                        end
                    end
            end
        end
        
        % Only get vibration parameters if not SoundOnly
        if sessionType ~= 2
            % Vibration parameters
            StimParams.Vibration.Type = get(h.Vib.Type, 'String');
            % StimParams.Vibration.Duration = str2double(get(h.Vib.Duration, 'String'));
            StimParams.Vibration.Amplitude = str2double(get(h.Vib.Amplitude, 'String'));
            StimParams.Vibration.Frequency = str2double(get(h.Vib.Frequency, 'String'));
        end

        % Behavior parameters
        StimParams.Behave.MinITI = str2double(get(h.Behave.MinITI, 'String'));
        StimParams.Behave.MaxITI = str2double(get(h.Behave.MaxITI, 'String'));
        StimParams.Behave.MinQuietTime = str2double(get(h.Behave.MinQuietTime, 'String'));
        StimParams.Behave.MaxQuietTime = str2double(get(h.Behave.MaxQuietTime, 'String'));
        StimParams.Behave.ResWin = str2double(get(h.Behave.ResWin, 'String'));
        StimParams.Behave.ValveTime = str2double(get(h.Behave.ValveTime, 'String'));
        StimParams.Behave.NumTrials = str2double(get(h.Behave.NumTrials, 'String'));

        % Save and display parameters
        guidata(h_gui, StimParams);
        disp('Stimulus parameters set:')
        disp(StimParams)
        
        uiresume(h_gui);
    end

    uiwait(h_gui);
    StimParams = guidata(h_gui);
    close(h_gui);
end